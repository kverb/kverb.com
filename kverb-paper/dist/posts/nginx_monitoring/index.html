<!DOCTYPE html><html lang="en" class="scroll-smooth"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="canonical" href="https://www.kverb.com/posts/nginx_monitoring/"><meta name="generator" content="Astro v4.13.0"><!-- General Meta Tags --><title>nginx metrics and log collection with grafana, prometheus, loki | kverb.com</title><meta name="title" content="nginx metrics and log collection with grafana, prometheus, loki | kverb.com"><meta name="description" content="A primer on how to enable metrics collection and monitoring for Nginx using the grafana stack"><meta name="author" content="Ken V"><link rel="sitemap" href="/sitemap-index.xml"><!-- Open Graph / Facebook --><meta property="og:title" content="nginx metrics and log collection with grafana, prometheus, loki | kverb.com"><meta property="og:description" content="A primer on how to enable metrics collection and monitoring for Nginx using the grafana stack"><meta property="og:url" content="https://www.kverb.com/posts/nginx_monitoring/"><meta property="og:image" content="https://www.kverb.com/posts/nginx-metrics-and-log-collection-with-grafana-prometheus-loki.png"><!-- Article Published/Modified time --><meta property="article:published_time" content="2022-06-11T16:45:58.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://www.kverb.com/posts/nginx_monitoring/"><meta property="twitter:title" content="nginx metrics and log collection with grafana, prometheus, loki | kverb.com"><meta property="twitter:description" content="A primer on how to enable metrics collection and monitoring for Nginx using the grafana stack"><meta property="twitter:image" content="https://www.kverb.com/posts/nginx-metrics-and-log-collection-with-grafana-prometheus-loki.png"><!-- Google JSON-LD Structured data --><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"nginx metrics and log collection with grafana, prometheus, loki | kverb.com","image":"https://www.kverb.com/posts/nginx-metrics-and-log-collection-with-grafana-prometheus-loki.png","datePublished":"2022-06-11T16:45:58.000Z","author":[{"@type":"Person","name":"Ken V","url":"https://keybase.io/kverb/"}]}</script><!-- Google Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet"><meta name="theme-color" content=""><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script src="/toggle-theme.js"></script><style>.breadcrumb:where(.astro-ilhxcym7){margin-left:auto;margin-right:auto;margin-bottom:.25rem;margin-top:2rem;width:100%;max-width:48rem;padding-left:1rem;padding-right:1rem}.breadcrumb:where(.astro-ilhxcym7) ul:where(.astro-ilhxcym7) li:where(.astro-ilhxcym7){display:inline}.breadcrumb:where(.astro-ilhxcym7) ul:where(.astro-ilhxcym7) li:where(.astro-ilhxcym7) a:where(.astro-ilhxcym7){text-transform:capitalize;opacity:.7}.breadcrumb:where(.astro-ilhxcym7) ul:where(.astro-ilhxcym7) li:where(.astro-ilhxcym7) span:where(.astro-ilhxcym7){opacity:.7}.breadcrumb:where(.astro-ilhxcym7) ul:where(.astro-ilhxcym7) li:where(.astro-ilhxcym7):not(:last-child) a:where(.astro-ilhxcym7):hover{opacity:1}
</style>
<link rel="stylesheet" href="/_astro/about.DBgwgaiN.css">
<style>#main-content:where(.astro-hsp6otuf){margin-left:auto;margin-right:auto;width:100%;max-width:48rem;padding-left:1rem;padding-right:1rem;padding-bottom:1rem}#main-content:where(.astro-hsp6otuf) h1:where(.astro-hsp6otuf){font-size:1.5rem;line-height:2rem;font-weight:600}@media (min-width: 640px){#main-content:where(.astro-hsp6otuf) h1:where(.astro-hsp6otuf){font-size:1.875rem;line-height:2.25rem}}#main-content:where(.astro-hsp6otuf) p:where(.astro-hsp6otuf){margin-bottom:1.5rem;margin-top:.5rem;font-style:italic}
a:where(.astro-blwjyjpt){position:relative;text-decoration-line:underline;text-decoration-style:dashed}a:where(.astro-blwjyjpt):hover{top:-.125rem;--tw-text-opacity: 1;color:rgba(var(--color-accent),var(--tw-text-opacity))}a:where(.astro-blwjyjpt):focus-visible{padding:.25rem}a:where(.astro-blwjyjpt) svg:where(.astro-blwjyjpt){margin-right:-1.25rem;height:1.5rem;width:1.5rem;--tw-scale-x: .95;--tw-scale-y: .95;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));--tw-text-opacity: 1;color:rgba(var(--color-text-base),var(--tw-text-opacity));opacity:.8}.group:where(.astro-blwjyjpt):hover a:where(.astro-blwjyjpt) svg:where(.astro-blwjyjpt){fill:rgb(var(--color-accent))}
@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0}}@keyframes astroFadeOut{to{opacity:0}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media (prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
.pagination-wrapper:where(.astro-d776pwuy){margin-bottom:2rem;margin-top:auto;display:flex;justify-content:center}.disabled:where(.astro-d776pwuy){pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;opacity:.5}.disabled:where(.astro-d776pwuy):hover{--tw-text-opacity: 1;color:rgba(var(--color-text-base),var(--tw-text-opacity))}.group:where(.astro-d776pwuy):hover .disabled:where(.astro-d776pwuy){fill:rgb(var(--color-text-base))}.group:where(.astro-d776pwuy):hover .disabled-svg:where(.astro-d776pwuy){fill:rgb(var(--color-text-base))!important}
.social-icons:where(.astro-wkojbtzc){display:flex;flex-direction:column;flex-wrap:wrap;align-items:center;justify-content:center;gap:.25rem}@media (min-width: 640px){.social-icons:where(.astro-wkojbtzc){align-items:flex-start}}.link-button:where(.astro-wkojbtzc){--tw-scale-x: .9;--tw-scale-y: .9;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));padding:.5rem}.link-button:where(.astro-wkojbtzc):hover{--tw-rotate: 6deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@media (min-width: 640px){.link-button:where(.astro-wkojbtzc){padding:.25rem}}main:where(.astro-vj4tpspi){margin-left:auto;margin-right:auto;width:100%;max-width:48rem;padding-left:1rem;padding-right:1rem;padding-bottom:3rem}.post-title:where(.astro-vj4tpspi){font-size:1.5rem;line-height:2rem;font-weight:600;--tw-text-opacity: 1;color:rgba(var(--color-accent),var(--tw-text-opacity))}
</style><script type="module" src="/_astro/hoisted.lSUI3qGY.js"></script><style>[data-astro-transition-scope="astro-plk3gbjq-1"] { view-transition-name: nginx-metrics-and-log-collection-with-grafana-prometheus-loki; }@layer astro { ::view-transition-old(nginx-metrics-and-log-collection-with-grafana-prometheus-loki) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(nginx-metrics-and-log-collection-with-grafana-prometheus-loki) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(nginx-metrics-and-log-collection-with-grafana-prometheus-loki) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(nginx-metrics-and-log-collection-with-grafana-prometheus-loki) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-36ssibgs-2"] { view-transition-name: others; }@layer astro { ::view-transition-old(others) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(others) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(others) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(others) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style></head> <body>  <header class="astro-3ef6ksr2"> <a id="skip-to-content" href="#main-content" class="astro-3ef6ksr2">Skip to content</a> <div class="nav-container astro-3ef6ksr2"> <div class="top-nav-wrap astro-3ef6ksr2"> <a href="/" class="logo whitespace-nowrap astro-3ef6ksr2"> kverb.com </a> <nav id="nav-menu" class="astro-3ef6ksr2"> <button class="hamburger-menu focus-outline astro-3ef6ksr2" aria-label="Open Menu" aria-expanded="false" aria-controls="menu-items"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="menu-icon astro-3ef6ksr2"> <line x1="7" y1="12" x2="21" y2="12" class="line astro-3ef6ksr2"></line> <line x1="3" y1="6" x2="21" y2="6" class="line astro-3ef6ksr2"></line> <line x1="12" y1="18" x2="21" y2="18" class="line astro-3ef6ksr2"></line> <line x1="18" y1="6" x2="6" y2="18" class="close astro-3ef6ksr2"></line> <line x1="6" y1="6" x2="18" y2="18" class="close astro-3ef6ksr2"></line> </svg> </button> <ul id="menu-items" class="display-none sm:flex astro-3ef6ksr2"> <li class="astro-3ef6ksr2"> <a href="/posts/" class=" astro-3ef6ksr2">
Posts
</a> </li> <li class="astro-3ef6ksr2"> <a href="/tags/" class=" astro-3ef6ksr2">
Tags
</a> </li> <li class="astro-3ef6ksr2"> <a href="/about/" class=" astro-3ef6ksr2">
About
</a> </li> <li class="astro-3ef6ksr2"> <a href="/search/" class="group inline-block hover:text-skin-accent focus-outline p-3 sm:p-1  flex astro-3ef6ksr2" aria-label="search" title="Search"> <svg xmlns="http://www.w3.org/2000/svg" class="scale-125 sm:scale-100 astro-3ef6ksr2"><path d="M19.023 16.977a35.13 35.13 0 0 1-1.367-1.384c-.372-.378-.596-.653-.596-.653l-2.8-1.337A6.962 6.962 0 0 0 16 9c0-3.859-3.14-7-7-7S2 5.141 2 9s3.14 7 7 7c1.763 0 3.37-.66 4.603-1.739l1.337 2.8s.275.224.653.596c.387.363.896.854 1.384 1.367l1.358 1.392.604.646 2.121-2.121-.646-.604c-.379-.372-.885-.866-1.391-1.36zM9 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z" class="astro-3ef6ksr2"></path> </svg> <span class="sr-only astro-3ef6ksr2">Search</span> </a> </li> <li class="astro-3ef6ksr2"> <button id="theme-btn" class="focus-outline astro-3ef6ksr2" title="Toggles light & dark" aria-label="auto" aria-live="polite"> <svg xmlns="http://www.w3.org/2000/svg" id="moon-svg" class="astro-3ef6ksr2"> <path d="M20.742 13.045a8.088 8.088 0 0 1-2.077.271c-2.135 0-4.14-.83-5.646-2.336a8.025 8.025 0 0 1-2.064-7.723A1 1 0 0 0 9.73 2.034a10.014 10.014 0 0 0-4.489 2.582c-3.898 3.898-3.898 10.243 0 14.143a9.937 9.937 0 0 0 7.072 2.93 9.93 9.93 0 0 0 7.07-2.929 10.007 10.007 0 0 0 2.583-4.491 1.001 1.001 0 0 0-1.224-1.224zm-2.772 4.301a7.947 7.947 0 0 1-5.656 2.343 7.953 7.953 0 0 1-5.658-2.344c-3.118-3.119-3.118-8.195 0-11.314a7.923 7.923 0 0 1 2.06-1.483 10.027 10.027 0 0 0 2.89 7.848 9.972 9.972 0 0 0 7.848 2.891 8.036 8.036 0 0 1-1.484 2.059z" class="astro-3ef6ksr2"></path> </svg> <svg xmlns="http://www.w3.org/2000/svg" id="sun-svg" class="astro-3ef6ksr2"> <path d="M6.993 12c0 2.761 2.246 5.007 5.007 5.007s5.007-2.246 5.007-5.007S14.761 6.993 12 6.993 6.993 9.239 6.993 12zM12 8.993c1.658 0 3.007 1.349 3.007 3.007S13.658 15.007 12 15.007 8.993 13.658 8.993 12 10.342 8.993 12 8.993zM10.998 19h2v3h-2zm0-17h2v3h-2zm-9 9h3v2h-3zm17 0h3v2h-3zM4.219 18.363l2.12-2.122 1.415 1.414-2.12 2.122zM16.24 6.344l2.122-2.122 1.414 1.414-2.122 2.122zM6.342 7.759 4.22 5.637l1.415-1.414 2.12 2.122zm13.434 10.605-1.414 1.414-2.122-2.122 1.414-1.414z" class="astro-3ef6ksr2"></path> </svg> </button> </li> </ul> </nav> </div> </div> <div class="max-w-3xl mx-auto px-4"> <hr class="border-skin-line" aria-hidden="true"> </div> </header>   <div class="mx-auto flex w-full max-w-3xl justify-start px-2 astro-vj4tpspi"> <button class="focus-outline mb-2 mt-8 flex hover:opacity-75 astro-vj4tpspi" onclick="(() => (history.length === 1) ? window.location = '/' : history.back())()"> <svg xmlns="http://www.w3.org/2000/svg" class="astro-vj4tpspi"><path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-vj4tpspi"></path> </svg><span class="astro-vj4tpspi">Go back</span> </button> </div> <main id="main-content" class="astro-vj4tpspi"> <h1 class="post-title astro-vj4tpspi" data-astro-transition-scope="astro-plk3gbjq-1">nginx metrics and log collection with grafana, prometheus, loki</h1> <div class="flex items-center space-x-2 opacity-80 my-2 astro-vj4tpspi"><svg xmlns="http://www.w3.org/2000/svg" class="scale-100 inline-block h-6 w-6 min-w-[1.375rem] fill-skin-base" aria-hidden="true"><path d="M7 11h2v2H7zm0 4h2v2H7zm4-4h2v2h-2zm0 4h2v2h-2zm4-4h2v2h-2zm0 4h2v2h-2z"></path><path d="M5 22h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2zM19 8l.001 12H5V8h14z"></path></svg><span class="sr-only">Published:</span><span class="italic text-base"><time dateTime="2022-06-11T16:45:58.000Z">Jun 11, 2022</time><span aria-hidden="true"> | </span><span class="sr-only"> at </span><span class="text-nowrap">04:45 PM</span></span></div> <article id="article" class="prose mx-auto mt-8 max-w-3xl astro-vj4tpspi"> <h2 id="meta">meta</h2>
<p><strong>Grafana</strong> - is the front-end dashboard website, that supports querying datasources, and displaying visualizatoins of the data. It is basically a full-stack webapp that you can self-host.</p>
<p><strong>Prometheus</strong> - is a metrics collection endpoint. It runs as an http server that also “scrapes” target services, periodically via http. It becomes the primary data source for counters/timeseries when using grafana dashboards. Conceptually, it is the main database for recording and facilitating queries against the metrics.</p>
<p><strong>Nginx Node exporter</strong> - it’s a confusing name, but in order for prometheus to scrape any useful data, it needs to be available to scrape on the target. The “node exporter” is what makes metrics data available for prometheus to scrape. There are many node exporters available for popular software services, including nginx.</p>
<p><strong>Loki</strong> - is like prometheus, but for text logs. I.e., it receives a stream of text, generally the recent lines of a log file. The encoding and format of each line can be arbitary. Loki will parse them as-is. Like prometheus, it becomes the primary datasource for log-based data and queries.</p>
<p><strong>Promtail</strong> - is a service that runs on the target node. It is what pushes data into Loki (Unlike prometheus, loki does not operate on a pull/scrape model). You can also think of the target as the “source of the logs data”. In this case, our target/source of data is our nginx metrics and logs. Promtail needs read access to the raw log files, and then streams it to Loki. Because of this, I run promtail directly on the nginx container.</p>
<h2 id="assumptions--pre-conditions">assumptions / pre-conditions</h2>
<ul>
<li>grafana, prometheus, and loki are already up and running correctly. These can/should be run on a separate container from nginx.</li>
<li>nginx is on a tailscale network that can access prometheus and Loki nodes
<ul>
<li>in my setup, loki runs on the prometheus node</li>
<li>this isn’t necessary; it just makes resolving the hosts secure and easy</li>
</ul>
</li>
<li>You’re not using something like docker containers. If you are, there are plenty of guides out there on how to do that.</li>
</ul>
<h2 id="set-up-the-node-exporter">Set up the node exporter</h2>
<p>There are probably distro packages/procedures for installing the nginx node exporter. Here’s how you can manually do it on linux. I do this from a root shell on the nginx container. The overall process is: download the ‣ binary release, unzip and install the executable somewhere, create a systemd service definition.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">#</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> download the binary</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478;font-style:inherit;--shiki-dark-font-style:italic">cd</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> ~/downloads</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">wget</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v0.10.0/nginx-prometheus-exporter_0.10.0_linux_amd64.tar.gz</span><span style="color:#2B5581;--shiki-dark:#82AAFF"> -O</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> ~/downloads/npe.tar.gz</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">#</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> un-archive</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">tar</span><span style="color:#2B5581;--shiki-dark:#82AAFF"> -xvf</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> npe.tar.gz</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">#</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> copy the binary to somewhere sane. Here i've chosen /opt/</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">cp</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> nginx-prometheus-exporter</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /opt/</span></span>
<span class="line"></span></code></pre>
<p>We’ll need to make a systemd service definition file. Here’s mine:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">$</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> cat</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /etc/systemd/system/nginx-prometheus-exporter.service</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">[Unit]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">Description</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">Prometheus</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> Node</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> Exporter</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> for</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> Nginx</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ConditionFileIsExecutable</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">/opt/nginx-prometheus-exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">After</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">syslog.target</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> network-online.target</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">[Service]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">StartLimitInterval</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">5</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">StartLimitBurst</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">10</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ExecStart</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">/opt/nginx-prometheus-exporter</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">SyslogIdentifier</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">prometheus</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">WorkingDirectory</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">/opt/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">Restart</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">always</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">RestartSec</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">[Install]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">WantedBy</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">multi-user.target</span></span>
<span class="line"></span></code></pre>
<p>In order for the node exporter to provide useful metrics, we need to enable the <code>stub_status</code> module for nginx. It’s basically a special built-in http endpoint that can be exposed through your nginx conf. This is the relevant snippet, that should go in a <code>sites-enabled</code> or in the root conf:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">server</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">	server_name</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> nginx</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">	listen</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 8080</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;  </span><span style="color:#C2C3C5;--shiki-dark:#637777">#</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> i'm not sure this port can be changed easily</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">	location</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> =</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /stub_status</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">		stub_status</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">	}</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<p>On the prometheus node, enable the scraping target</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">$</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> cat</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /etc/prometheus/prometheus.yml</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#7FDBCA">&#x3C;</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> ... </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">-</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> job_name:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">nginx_node</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">    static_configs:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">      -</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> targets:</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> [</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">nginx:9113</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">]  </span><span style="color:#C2C3C5;--shiki-dark:#637777">#</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> NOTE: this needs to point to your nginx host</span></span>
<span class="line"></span></code></pre>
<h2 id="loki--promtail">Loki + Promtail</h2>
<p>As stated in the preface, in order to make the the nginx logs accessible in grafana+loki, we need a promtail instance that can read the raw logs files. On docker-style containers, there’s various incantations to bind-mount the nginx logs directories into a promtail container, but I think it’s just much more straight-forward to install promtail directly in the nginx container. Again, there’s probably a simple and straighforward way to install promtail via your distro’s package manager, but here are the manual steps:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">#</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> download the binary</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478;font-style:inherit;--shiki-dark-font-style:italic">cd</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> ~/downloads</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">wget</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> https://github.com/grafana/loki/releases/download/v2.4.2/promtail-linux-amd64.zip</span><span style="color:#2B5581;--shiki-dark:#82AAFF"> -O</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> ~/promtail.zip</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">#</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> unzip and copy to a sane place</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">unzip</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> promtail.zip</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">mkdir</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /opt/promtail</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">cp</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /opt/promtail/promtail</span></span>
<span class="line"></span></code></pre>
<p>Promtail requires a small config file. You can put it anywhere, but I’ll put it in <code>/opt/promtail</code></p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">$</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> cat</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /opt/promtail/promtail.yml</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> </span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">server:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">  http_listen_port:</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 9080</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">  grpc_listen_port:</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">positions:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">  filename:</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /tmp/positions.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">clients:</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">                #</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> make sure this host is your LOKI hostname</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">  -</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> url:</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> http://prometheus:3100/loki/api/v1/push</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">scrape_configs:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">  -</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> job_name:</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> system</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">    static_configs:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">    -</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> targets:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        -</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> localhost</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">      labels:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        job:</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> varlogs</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        __path__:</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /var/log/</span><span style="color:#2B5581;--shiki-dark:#7FDBCA">*</span><span style="color:#2B5581;--shiki-dark:#ECC48D">log</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">  -</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> job_name:</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> nginx</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">    static_configs:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">    -</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> targets:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        -</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> localhost</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">      labels:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        job:</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> nginx</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        __path__:</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /var/log/nginx/</span><span style="color:#2B5581;--shiki-dark:#7FDBCA">*</span><span style="color:#2B5581;--shiki-dark:#ECC48D">log</span></span>
<span class="line"></span></code></pre>
<p>And create a systemd service definition:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">$</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> cat</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /etc/systemd/system/promtail.service</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">[Unit]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">Description</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">promtail</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> is</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> the</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> agent</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> responsible</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> for</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> gathering</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> logs</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> and</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> sending</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> them</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> to</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> Loki.</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">Documentation</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">https://grafana.com/docs/loki/latest/clients/promtail/</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">Requires</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">network-online.target</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">After</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">network-online.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">[Service]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">Type</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">simple</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ExecStart</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">/opt/promtail/promtail</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> -positions.file</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /var/lib/promtail/positions.yml</span><span style="color:#2B5581;--shiki-dark:#82AAFF"> -config.file</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> /opt/promtail/promtail.yml</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">User</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">promtail</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">TimeoutStopSec</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">30s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">NoNewPrivileges</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">MemoryDenyWriteExecute</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">RestrictRealtime</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ProtectHome</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ProtectSystem</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">strict</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ReadWritePaths</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">/var/lib/promtail</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">PrivateTmp</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">PrivateDevices</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ProtectKernelTunables</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ProtectKernelModules</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">ProtectControlGroups</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">[Install]</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#C5E478">WantedBy</span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#2B5581;--shiki-dark:#ECC48D">multi-user.target</span></span>
<span class="line"></span></code></pre>
<p>Reload systemd and enable and start the new services:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">$</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> systemctl</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> daemon-reload</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">$</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> systemctl</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> enable</span><span style="color:#2B5581;--shiki-dark:#82AAFF"> --now</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> promtail</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">$</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> systemctl</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> enable</span><span style="color:#2B5581;--shiki-dark:#82AAFF"> --now</span><span style="color:#2B5581;--shiki-dark:#ECC48D"> nginx-prometheus-exporter</span></span>
<span class="line"></span></code></pre>
<p>You can verify nginx-prometheus-exporter is working by checking its http endpoint: <a href="http://nginx:9113/metrics">http://nginx:9113/metrics</a></p>
<p>And promtail: <a href="http://nginx:9080/targets">http://nginx:9080/targets</a></p>
<h2 id="dashboards-in-grafana">Dashboards in grafana</h2>
<p>I’m using dashboard queries and viz based on <a href="https://grafana.com/grafana/dashboards/13865">this dashboard</a>. It requires some slight modifications to the queries to get accurate data. A lot of the queries have extra filters that are specific to the original author.</p> </article> <ul class="my-8 astro-vj4tpspi"> <li class="inline-block my-1 underline-offset-4 astro-blwjyjpt"> <a href="/tags/others/" class="text-sm pr-2 group astro-blwjyjpt" data-astro-transition-scope="astro-36ssibgs-2"> <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-blwjyjpt"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-blwjyjpt"></path> </svg>
&nbsp;<span class="astro-blwjyjpt">others</span> </a> </li>  </ul> <div class="flex flex-col-reverse items-center justify-between gap-6 sm:flex-row-reverse sm:items-end sm:gap-4 astro-vj4tpspi"> <button id="back-to-top" class="focus-outline whitespace-nowrap py-1 hover:opacity-75 astro-vj4tpspi"> <svg xmlns="http://www.w3.org/2000/svg" class="rotate-90 astro-vj4tpspi"> <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-vj4tpspi"></path> </svg> <span class="astro-vj4tpspi">Back to Top</span> </button> <div class="social-icons astro-wkojbtzc"> <span class="italic astro-wkojbtzc">Share this post on:</span> <div class="text-center astro-wkojbtzc"> <a href="https://wa.me/?text=https://www.kverb.com/posts/nginx_monitoring/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post via WhatsApp"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 21l1.65 -3.8a9 9 0 1 1 3.4 2.9l-5.05 .9"></path>
      <path d="M9 10a0.5 .5 0 0 0 1 0v-1a0.5 .5 0 0 0 -1 0v1a5 5 0 0 0 5 5h1a0.5 .5 0 0 0 0 -1h-1a0.5 .5 0 0 0 0 1"></path>
    </svg> <span class="sr-only astro-wkojbtzc">Share this post via WhatsApp</span> </a><a href="mailto:?subject=See%20this%20post&#38;body=https://www.kverb.com/posts/nginx_monitoring/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post via email"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <rect x="3" y="5" width="18" height="14" rx="2"></rect>
      <polyline points="3 7 12 13 21 7"></polyline>
    </svg> <span class="sr-only astro-wkojbtzc">Share this post via email</span> </a> </div> </div>  </div> </main> <footer class="mt-auto astro-sz7xmlte"> <div class="max-w-3xl mx-auto px-0"> <hr class="border-skin-line" aria-hidden="true"> </div> <div class="footer-wrapper astro-sz7xmlte"> <div class="social-icons flex astro-upu6fzxr"> <a href="https://github.com/kverb/kverb.com" class="group inline-block hover:text-skin-accent link-button astro-upu6fzxr" title=" kverb.com on Github"> <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path
      d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"
    ></path>
  </svg> <span class="sr-only astro-upu6fzxr"> kverb.com on Github</span> </a><a href="https://instagram.com/kverb" class="group inline-block hover:text-skin-accent link-button astro-upu6fzxr" title="kverb.com on Instagram"> <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <rect x="4" y="4" width="16" height="16" rx="4"></rect>
    <circle cx="12" cy="12" r="3"></circle>
    <line x1="16.5" y1="7.5" x2="16.5" y2="7.501"></line>
  </svg> <span class="sr-only astro-upu6fzxr">kverb.com on Instagram</span> </a><a href="mailto:ken@kverb.com" class="group inline-block hover:text-skin-accent link-button astro-upu6fzxr" title="Send an email to kverb.com"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <rect x="3" y="5" width="18" height="14" rx="2"></rect>
      <polyline points="3 7 12 13 21 7"></polyline>
    </svg> <span class="sr-only astro-upu6fzxr">Send an email to kverb.com</span> </a> </div>  <div class="copyright-wrapper astro-sz7xmlte"> <span class="astro-sz7xmlte">Copyright &#169; lmao</span> <span class="separator astro-sz7xmlte">&nbsp;|&nbsp;</span> <span class="astro-sz7xmlte">All rights reserved.</span> </div> </div> </footer>   </body></html>  <script>
  /** Create a progress indicator
   *  at the top */
  function createProgressBar() {
    // Create the main container div
    const progressContainer = document.createElement("div");
    progressContainer.className =
      "progress-container fixed top-0 z-10 h-1 w-full bg-skin-fill";

    // Create the progress bar div
    const progressBar = document.createElement("div");
    progressBar.className = "progress-bar h-1 w-0 bg-skin-accent";
    progressBar.id = "myBar";

    // Append the progress bar to the progress container
    progressContainer.appendChild(progressBar);

    // Append the progress container to the document body or any other desired parent element
    document.body.appendChild(progressContainer);
  }
  createProgressBar();

  /** Update the progress bar
   *  when user scrolls */
  function updateScrollProgress() {
    const winScroll =
      document.body.scrollTop || document.documentElement.scrollTop;
    const height =
      document.documentElement.scrollHeight -
      document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    if (document) {
      const myBar = document.getElementById("myBar");
      if (myBar) {
        myBar.style.width = scrolled + "%";
      }
    }
  }
  document.addEventListener("scroll", updateScrollProgress);

  /** Attaches links to headings in the document,
   *  allowing sharing of sections easily */
  function addHeadingLinks() {
    let headings = Array.from(document.querySelectorAll("h2, h3, h4, h5, h6"));
    for (let heading of headings) {
      heading.classList.add("group");
      const link = document.createElement("a");
      link.className =
        "heading-link ml-2 opacity-0 group-hover:opacity-100 focus:opacity-100";
      link.href = "#" + heading.id;

      const span = document.createElement("span");
      span.ariaHidden = "true";
      span.innerText = "#";
      link.appendChild(span);
      heading.appendChild(link);
    }
  }
  addHeadingLinks();

  /** Attaches copy buttons to code blocks in the document,
   * allowing users to copy code easily. */
  function attachCopyButtons() {
    let copyButtonLabel = "Copy";
    let codeBlocks = Array.from(document.querySelectorAll("pre"));

    for (let codeBlock of codeBlocks) {
      let wrapper = document.createElement("div");
      wrapper.style.position = "relative";

      let copyButton = document.createElement("button");
      copyButton.className =
        "copy-code absolute right-3 -top-3 rounded bg-skin-card px-2 py-1 text-xs leading-4 text-skin-base font-medium";
      copyButton.innerHTML = copyButtonLabel;
      codeBlock.setAttribute("tabindex", "0");
      codeBlock.appendChild(copyButton);

      // wrap codebock with relative parent element
      codeBlock?.parentNode?.insertBefore(wrapper, codeBlock);
      wrapper.appendChild(codeBlock);

      copyButton.addEventListener("click", async () => {
        await copyCode(codeBlock, copyButton);
      });
    }

    async function copyCode(block, button) {
      let code = block.querySelector("code");
      let text = code?.innerText;

      await navigator.clipboard.writeText(text ?? "");

      // visual feedback that task is completed
      button.innerText = "Copied";

      setTimeout(() => {
        button.innerText = copyButtonLabel;
      }, 700);
    }
  }
  attachCopyButtons();

  /** Scrolls the document to the top when
   * the "Back to Top" button is clicked. */
  function backToTop() {
    document.querySelector("#back-to-top")?.addEventListener("click", () => {
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    });
  }
  backToTop();
</script>